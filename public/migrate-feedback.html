<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feedback Data Recovery</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Feedback Data Recovery Tool</h1>
        <p>This tool will recover your feedback items from the index-based storage format and migrate them to the array format.</p>
        
        <div>
            <button id="checkBtn" onclick="checkData()">1. Check Current Data</button>
            <button id="migrateBtn" onclick="migrateData()" disabled>2. Run Migration</button>
            <button id="verifyBtn" onclick="verifyData()" disabled>3. Verify Results</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script>
        let authToken = null;
        let foundItems = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        async function checkData() {
            log('ðŸ” Checking authentication...', 'info');
            authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                log('âŒ Not logged in! Please log in to the app first.', 'error');
                return;
            }
            
            log('âœ… Authenticated', 'success');
            log('ðŸ“¦ Checking current feedback data...', 'info');
            
            try {
                // Check current array format
                const response = await fetch('/api/storage?key=feedbackItems', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                const currentItems = Array.isArray(data) ? data : [];
                
                log(`ðŸ“‹ Current items in array format: ${currentItems.length}`, 'info');
                
                // Check localStorage cache
                const cached = localStorage.getItem('feedbackItemsCache:v1');
                const cachedItems = cached ? JSON.parse(cached) : [];
                log(`ðŸ’¾ Cached items in localStorage: ${cachedItems.length}`, 'info');
                
                if (currentItems.length > 0) {
                    log(`âš ï¸  Warning: Found ${currentItems.length} items already in array format`, 'warning');
                    log('   Migration will merge with existing data (no duplicates)', 'warning');
                }
                
                log('âœ… Data check complete', 'success');
                log('', 'info');
                log('âš ï¸  IMPORTANT: The migration requires access to KV store listing', 'warning');
                log('   This can only be done server-side via the API endpoint', 'warning');
                log('   Please deploy the fix/feedback-data-recovery branch first', 'warning');
                log('', 'info');
                log('Alternative: Manual recovery via Wrangler CLI', 'info');
                log('See FEEDBACK_RECOVERY_INSTRUCTIONS.md for details', 'info');
                
                document.getElementById('migrateBtn').disabled = false;
                
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }
        
        async function migrateData() {
            log('ðŸš€ Starting migration...', 'info');
            log('âš ï¸  This requires the migration endpoint to be deployed', 'warning');
            
            try {
                const response = await fetch('/api/migrate-feedback', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 405) {
                        log('âŒ Migration endpoint not deployed yet', 'error');
                        log('', 'info');
                        log('ðŸ“ To deploy:', 'info');
                        log('1. Merge the fix/feedback-data-recovery branch', 'info');
                        log('2. Wait for Cloudflare Pages to deploy', 'info');
                        log('3. Come back and run this migration', 'info');
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    log('âœ… Migration successful!', 'success');
                    log(`ðŸ“Š Statistics:`, 'info');
                    log(`   - Found in index format: ${result.stats.foundInIndexFormat}`, 'info');
                    log(`   - Loaded successfully: ${result.stats.loadedSuccessfully}`, 'info');
                    log(`   - Existing in array: ${result.stats.existingInArrayFormat}`, 'info');
                    log(`   - New items migrated: ${result.stats.newItemsMigrated}`, 'success');
                    log(`   - Total after migration: ${result.stats.totalAfterMigration}`, 'success');
                    
                    if (result.stats.errors > 0) {
                        log(`âš ï¸  Errors: ${result.stats.errors}`, 'warning');
                    }
                    
                    document.getElementById('verifyBtn').disabled = false;
                } else {
                    log(`âŒ Migration failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }
        
        async function verifyData() {
            log('ðŸ” Verifying migration results...', 'info');
            
            try {
                const response = await fetch('/api/storage?key=feedbackItems', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                const items = Array.isArray(data) ? data : [];
                
                log(`âœ… Verification complete`, 'success');
                log(`ðŸ“Š Total items in storage: ${items.length}`, 'success');
                
                if (items.length > 0) {
                    const pending = items.filter(i => i.status !== 'done').length;
                    const done = items.filter(i => i.status === 'done').length;
                    log(`   - Pending: ${pending}`, 'info');
                    log(`   - Done: ${done}`, 'info');
                    
                    log('', 'info');
                    log('ðŸŽ‰ Migration successful! You can now:', 'success');
                    log('   1. Close this page', 'info');
                    log('   2. Go to the Feedback section in the app', 'info');
                    log('   3. All your items should be visible', 'info');
                } else {
                    log('âš ï¸  No items found after migration', 'warning');
                }
                
            } catch (error) {
                log(`âŒ Error: ${error.message}`, 'error');
            }
        }
        
        // Auto-check on load
        window.addEventListener('load', () => {
            log('ðŸ”§ Feedback Data Recovery Tool', 'info');
            log('Click "1. Check Current Data" to begin', 'info');
            log('', 'info');
        });
    </script>
</body>
</html>
