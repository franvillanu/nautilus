#!/bin/sh
#
# Nautilus Pre-Commit Hook
# 1. Prevents direct commits to the main branch
# 2. Auto-updates version strings based on content hashes
#
# Setup: git config core.hooksPath hooks
#
# See: CLAUDE.md#git-workflow for full workflow documentation
#

# Get current branch name
branch=$(git branch --show-current)

# Block commits to main
if [ "$branch" = "main" ]; then
    echo ""
    echo "âŒ ERROR: Direct commits to main are not allowed"
    echo ""
    echo "The Nautilus workflow requires all changes to be made on feature branches."
    echo ""
    echo "To fix this:"
    echo "  1. Create a feature branch:"
    echo "     git checkout -b feature/your-feature-name"
    echo ""
    echo "  2. Your changes are still staged - they'll move to the new branch"
    echo ""
    echo "  3. Commit on the new branch:"
    echo "     git commit -m \"Your commit message\""
    echo ""
    echo "  4. Push the branch:"
    echo "     git push -u origin feature/your-feature-name"
    echo ""
    echo "  5. Create a pull request on GitHub"
    echo ""
    echo "For more info, see: CLAUDE.md#git-workflow"
    echo ""
    exit 1
fi

# Auto-update version strings based on content hashes
# This eliminates manual version string maintenance
echo "ðŸ”„ Auto-updating version strings..."

# Run the auto-version script
if [ -f "scripts/auto-version.ps1" ]; then
    pwsh -ExecutionPolicy Bypass -File "scripts/auto-version.ps1" 2>/dev/null

    # Stage any files that were updated by the script
    git add -u index.html app.js src/main.js src/core/viewLoader.js src/services/storage.js 2>/dev/null

    echo "âœ… Version strings updated"
fi

# Allow commits on all other branches
exit 0
